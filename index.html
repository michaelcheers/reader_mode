<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reader Mode - PDF & Word Document Reader</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        
        .upload-area.dragover {
            border-color: #007bff;
            background-color: #f8f9ff;
        }
        
        .upload-btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .upload-btn:hover {
            background: #0056b3;
        }
        
        #file-input {
            display: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }
        
        .reader-content {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            line-height: 1.6;
            font-size: 16px;
            max-height: 600px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Reader Mode</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            Upload a PDF or Word document to read it in a clean, distraction-free format
        </p>
        
        <div class="upload-area" id="upload-area">
            <div>
                <p>Drag and drop your PDF or Word documents here</p>
                <p style="margin: 10px 0; color: #999;">or</p>
                <button class="upload-btn" onclick="document.getElementById('file-input').click()">
                    Choose Files
                </button>
                <input type="file" id="file-input" accept=".pdf,.doc,.docx" multiple />
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Extracting text...</p>
        </div>
        
        <div class="error" id="error"></div>
        
        <div style="margin: 30px 0; padding: 20px; border-top: 1px solid #ddd;">
            <h3 style="margin-top: 0; color: #333;">Or paste text directly:</h3>
            <textarea 
                id="text-input" 
                placeholder="Paste your text content here..."
                style="width: 100%; height: 200px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit; font-size: 14px; resize: vertical;"
            ></textarea>
            <button 
                id="text-submit" 
                class="upload-btn" 
                style="margin-top: 10px;"
            >
                Read Text
            </button>
        </div>
        
        <div class="reader-content" id="reader-content"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    
    <script>
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const textInput = document.getElementById('text-input');
        const textSubmit = document.getElementById('text-submit');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const readerContent = document.getElementById('reader-content');

        // Set up PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // IndexedDB helpers
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ReaderDB', 1);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('store')) {
                        db.createObjectStore('store');
                    }
                };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function idbSet(key, value) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('store', 'readwrite');
                tx.objectStore('store').put(value, key);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        async function idbGet(key) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('store', 'readonly');
                const req = tx.objectStore('store').get(key);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        async function idbClear() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('store', 'readwrite');
                tx.objectStore('store').clear();
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        // Check for content in IndexedDB on page load
        window.addEventListener('DOMContentLoaded', async () => {
            const savedContent = await idbGet('readerContent');
            const savedTitle = await idbGet('pageTitle');
            
            if (savedContent) {
                if (savedTitle) {
                    document.title = savedTitle;
                }
                
                await idbClear();
                
                uploadArea.style.display = 'none';
                document.querySelector('[style*="border-top"]').style.display = 'none';
                readerContent.innerHTML = savedContent;
                readerContent.style.display = 'block';
                
                const backButton = document.createElement('button');
                backButton.textContent = 'â† Upload More Documents';
                backButton.style.cssText = `
                    background: #6c757d;
                    color: white;
                    padding: 10px 20px;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                    margin-bottom: 20px;
                `;
                backButton.addEventListener('click', () => {
                    uploadArea.style.display = 'block';
                    document.querySelector('[style*="border-top"]').style.display = 'block'; // Show text input area
                    readerContent.style.display = 'none';
                    fileInput.value = ''; // Clear file input
                    textInput.value = ''; // Clear text input
                });
                readerContent.insertBefore(backButton, readerContent.firstChild);
            }
        });

        // Drag and drop handlers
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                handleFiles(files);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const files = Array.from(e.target.files);
                handleFiles(files);
            }
        });

        // Text input handler
        textSubmit.addEventListener('click', () => {
            const text = textInput.value.trim();
            if (text) {
                const textDocument = {
                    name: 'Pasted Text',
                    text: text
                };
                displayDocuments([textDocument]);
            }
        });

        async function handleFiles(files) {
            hideError();
            showLoading();
            readerContent.innerHTML = ''; // Clear previous content
            
            try {
                const documents = [];
                
                for (const file of files) {
                    let text = '';
                    
                    if (file.type === 'application/pdf') {
                        text = await extractPdfText(file);
                    } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || 
                              file.type === 'application/msword') {
                        text = await extractWordText(file);
                    } else {
                        console.warn(`Skipping unsupported file type: ${file.name}`);
                        continue;
                    }
                    
                    if (text.trim()) {
                        documents.push({ name: file.name, text: text });
                    }
                }
                
                if (documents.length === 0) {
                    throw new Error('No valid documents could be processed. Please upload PDF or Word documents.');
                }
                
                displayDocuments(documents);
            } catch (err) {
                showError(err.message);
            } finally {
                hideLoading();
            }
        }

        async function extractPdfText(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let text = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                text += pageText + '\n\n';
            }
            
            return text.trim();
        }

        async function extractWordText(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
            return result.value;
        }

        async function displayDocuments(documents) {
            let contentHtml = '';
            
            documents.forEach((doc, index) => {
                contentHtml += `
                    <div style="margin-bottom: 40px; ${index > 0 ? 'border-top: 2px solid #eee; padding-top: 40px;' : ''}">
                        <h2 style="color: #333; font-size: 24px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            ðŸ“„ ${doc.name}
                        </h2>
                        <div style="white-space: pre-wrap; font-family: Georgia, serif; line-height: 1.8; color: #444;">
                            ${doc.text.replace(/\n\n+/g, '</p><p>').replace(/^/, '<p>').replace(/$/, '</p>')}
                        </div>
                    </div>
                `;
            });
            
            const pageTitle = documents.length === 1 ? 
                documents[0].name : 
                `${documents.length} Documents`;
            
            await idbSet('readerContent', contentHtml);
            await idbSet('pageTitle', pageTitle);
            location.reload();
        }

        function showLoading() {
            loading.style.display = 'block';
            readerContent.style.display = 'none';
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
            readerContent.style.display = 'none';
        }

        function hideError() {
            error.style.display = 'none';
        }
    </script>
</body>
</html>